name: Build

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'

      - name: Install dependencies
        run: flutter pub get

      - name: Set up libmpv_dart
        run: dart run libmpv_dart:setup --platform windows

      - name: Set up whisper4dart (using prebuilt library)
        run: dart run whisper4dart:setup --prebuilt

      - name: Build Windows App
        run: flutter build windows

      - name: Upload Windows Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows/x64/runner/Release/

  # 构建Linux Debian版本并创建.deb安装包
  build-linux-debian:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'

      - name: Install dependencies
        run: flutter pub get

      - name: Set up whisper4dart (using prebuilt library)
        run: dart run whisper4dart:setup --prebuilt

      - name: Install necessary libraries for Debian
        run: |
          flutter doctor
          sudo apt-get update -y
          # 安装Flutter Linux构建所需的基本依赖
          sudo apt-get install -y ninja-build libgtk-3-dev libmpv-dev
          # 安装其他可能在Debian上需要的依赖
          sudo apt-get install -y build-essential pkg-config cmake libssl-dev
          # 确保dpkg-deb工具可用（用于创建.deb包）
          sudo apt-get install -y dpkg-dev
          flutter doctor

      - name: Build Linux App
        run: flutter build linux --release

      - name: Create Debian package structure
        run: |
          # 创建Debian包的基本目录结构
          mkdir -p debian-package/usr/local/bin
          mkdir -p debian-package/usr/share/applications
          mkdir -p debian-package/usr/share/icons/hicolor/512x512/apps
          
          # 复制可执行文件和相关文件
          cp -r build/linux/x64/release/bundle/* debian-package/usr/local/bin/
          
          # 复制图标（如果存在）
          if [ -f "res/images/icon512.png" ]; then
            cp res/images/icon512.png debian-package/usr/share/icons/hicolor/512x512/apps/playboy.png
          fi
          
          # 创建桌面文件
          cat > debian-package/usr/share/applications/playboy.desktop << EOF
          [Desktop Entry]
          Name=Playboy
          Comment=媒体播放器应用
          Exec=/usr/local/bin/playboy
          Icon=playboy
          Terminal=false
          Type=Application
          Categories=AudioVideo;Player;
          EOF

      - name: Create Debian package metadata
        run: |
          mkdir -p debian-package/DEBIAN
          # 创建control文件
          cat > debian-package/DEBIAN/control << EOF
          Package: playboy
          Version: 1.0.0
          Section: multimedia
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libmpv1
          Maintainer: Playboy Team <team@example.com>
          Description: Modern media player application
           A feature-rich media player built with Flutter.
          EOF
          # 创建postinst脚本以确保权限正确
          cat > debian-package/DEBIAN/postinst << EOF
          #!/bin/sh
          chmod 755 /usr/local/bin/playboy
          update-desktop-database
          EOF
          chmod 755 debian-package/DEBIAN/postinst

      - name: Build Debian package
        run: |
          cd debian-package
          find . -type f ! -regex '.*DEBIAN.*' -exec md5sum {} \; | sed 's|\./||' > DEBIAN/md5sums
          cd ..
          dpkg-deb --build debian-package playboy_1.0.0_amd64.deb

      - name: Upload Linux Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-debian-build
          path: |
            build/linux/
            debian-package/
            playboy_1.0.0_amd64.deb

  # build-macos:
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Install Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.29.0'

  #     - name: Install dependencies
  #       run: flutter pub get

  #     - name: Set up Flutter for macOS
  #       run: flutter config --enable-macos-desktop

  #     - name: Build macOS App
  #       run: flutter build macos

  #     - name: Upload macOS Build Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-build
  #         path: build/macos/Build/Products/Release/

  # build-android:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Install Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.29.0'

  #     - name: Install dependencies
  #       run: flutter pub get

  #     - name: Build Android App
  #       run: flutter build apk

  #     - name: Upload Android Build Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-apk
  #         path: build/app/outputs/apk/release/app-release.apk